<div class="row user-profile">
  <div class="col-xs-10 col-xs-offset-1">
    <form id="userProfile" role="form" class="center-block">

      <div class="form-group">
        <label for="userForename">Forename</label>
        <input type="text" value="<%= @user.forename -%>" class="form-control" id="userForename" placeholder="Enter forename">
      </div>

      <div class="form-group">
        <label for="userLastname">Lastname</label>
        <input type="text" value="<%= @user.lastname -%>" class="form-control" id="userLastname" placeholder="Enter lastname">
      </div>

      <div class="form-group">
        <label for="userEmail">Email address</label>
        <input type="email" value="<%= @user.email -%>" class="form-control" id="userEmail" placeholder="Enter email">
      </div>

      <div class="form-group">
        <label for="country">Country</label>
        <select id="country" name="country" class="form-control is-required">
          <% @countries.each do |c| %>
          <option value="<%= c.iso3166_a2 -%>" <% if c == @user.country %>selected="selected"<% end %>>
            <%= c.name -%>
          </option>
          <% end %>
        </select>
      </div>

      <div class="alert alert-danger" id="userProfileErrors" style="display: none">
        <strong>Error!</strong> <span class="alert-content"></span>
      </div>

      <button type="submit" class="btn btn-default" disabled="disabled">Save</button>
      <img src="/img/ajax-loader.gif" id="loader" style="display: none">
      <span class="label label-success" id="success" style="display: none">Success</span>
    </form>

  </div>
</div>


<% content_for :scripts do %>
<script>
  $(function() {

    Evercam.User.by_login('<%= @user.username -%>')
    .then(function(user) {

      $('#userProfile').on('submit', function(e) {
        e.preventDefault();
        $('#userProfileErrors').hide();
        $('#loader').show();

        var toUpdate= [];
        if (user.data.forename !== $('#userForename').val()) {
          user.data.forename = $('#userForename').val();
          toUpdate.push('forename');
        }
        if (user.data.lastname !== $('#userLastname').val()) {
          user.data.lastname = $('#userLastname').val();
          toUpdate.push('lastname');
        }
        if (user.data.email !== $('#userEmail').val()) {
          user.data.email = $('#userEmail').val();
          toUpdate.push('email');
        }
        if (user.data.country !== $('#country').val()) {
          user.data.country = $('#country').val();
          toUpdate.push('country');
        }
        user.update(toUpdate)
        .done(function() {
          console.log('updated');
          $('#success').fadeIn().delay(2000).fadeOut('slow');
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.log( errorThrown + ' - ' + jqXHR.responseJSON.message);
          $('#userProfileErrors').find('.alert-content').text(jqXHR.responseJSON.message);
          $('#userProfileErrors').show();
        })
        .always(function() {
          $('#loader').hide();
        });

      });

      $('button[type="submit"]').removeAttr('disabled');

    });

  });
</script>
<% end %>
